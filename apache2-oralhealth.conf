<VirtualHost *:80>
    ServerName polyu.ice-solution.hk
    ServerAlias www.polyu.ice-solution.hk
    
    # 日誌文件
    ErrorLog ${APACHE_LOG_DIR}/polyu-error.log
    CustomLog ${APACHE_LOG_DIR}/polyu-access.log combined
    
    # 文檔根目錄（前端 React 應用）
    DocumentRoot /var/www/polyuoral/client/build
    
    # 前端 React 應用配置
    <Directory /var/www/polyuoral/client/build>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # React Router 支持 - 所有路由都指向 index.html
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </Directory>
    
    # API 反向代理到 Node.js 後端（端口 3101）
    ProxyPreserveHost On
    ProxyRequests Off
    
    # 設置全局代理超時時間（報告生成需要較長時間）
    ProxyTimeout 600
    
    # API 路由代理
    # 注意：ProxyPass 的行為取決於是否有尾隨斜線
    # 
    # 方式 1: ProxyPass http://localhost:3101/api (有 /api)
    #   - 請求 /api/auth/login → 轉發到 http://localhost:3101/api/auth/login ✅
    #
    # 方式 2: ProxyPass http://localhost:3101 (無尾隨斜線)
    #   - 請求 /api/auth/login → 轉發到 http://localhost:3101/api/auth/login ✅
    #   - Location 匹配的部分會被保留
    #
    # 方式 3: ProxyPass http://localhost:3101/ (有尾隨斜線)
    #   - 請求 /api/auth/login → 轉發到 http://localhost:3101/auth/login ❌
    #   - Location 匹配的部分會被替換
    #
    # 根據後端路由結構（都有 /api 前綴），使用方式 1 或 2 都可以
    <Location /api>
        ProxyPass http://localhost:3101/api
        ProxyPassReverse http://localhost:3101/api
        
        # 設置代理頭部
        RequestHeader set X-Real-IP %{REMOTE_ADDR}e
        RequestHeader set X-Forwarded-For %{REMOTE_ADDR}e
        RequestHeader set X-Forwarded-Proto "http"
        RequestHeader set X-Forwarded-Host %{HTTP_HOST}e
        
        # CORS 頭部（如果需要）
        Header always set Access-Control-Allow-Origin "*"
        Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Header always set Access-Control-Allow-Headers "Content-Type, Authorization"
    </Location>
    
    # 靜態文件代理（圖片等）
    <Location /public>
        ProxyPass http://localhost:3101/public
        ProxyPassReverse http://localhost:3101/public
    </Location>
    
    # 報告生成代理（使用相同的超時設置）
    <Location /api/report>
        ProxyPass http://localhost:3101/api/report
        ProxyPassReverse http://localhost:3101/api/report
    </Location>
    
    # 安全頭部
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    
    # Gzip 壓縮（暫時禁用，避免 JavaScript 文件損壞）
    # <IfModule mod_deflate.c>
    #     AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
    # </IfModule>
    
    # 緩存設置（暫時禁用，避免緩存問題）
    # <IfModule mod_expires.c>
    #     ExpiresActive On
    #     ExpiresByType image/jpeg "access plus 1 year"
    #     ExpiresByType image/png "access plus 1 year"
    #     ExpiresByType image/gif "access plus 1 year"
    #     ExpiresByType application/javascript "access plus 1 month"
    #     ExpiresByType text/css "access plus 1 month"
    # </IfModule>
    
    # 禁用緩存（調試時使用，生產環境可以移除）
    <IfModule mod_headers.c>
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires "0"
    </IfModule>
</VirtualHost>

