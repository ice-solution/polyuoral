<VirtualHost *:80>
    ServerName oralhealth.ice-solution.hk
    ServerAlias www.oralhealth.ice-solution.hk
    
    # 日誌文件
    ErrorLog ${APACHE_LOG_DIR}/oralhealth-error.log
    CustomLog ${APACHE_LOG_DIR}/oralhealth-access.log combined
    
    # 文檔根目錄（前端 React 應用）
    DocumentRoot /var/www/oralhealth/client/build
    
    # 前端 React 應用配置
    <Directory /var/www/oralhealth/client/build>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # React Router 支持 - 所有路由都指向 index.html
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </Directory>
    
    # API 反向代理到 Node.js 後端（端口 3101）
    ProxyPreserveHost On
    ProxyRequests Off
    
    # API 路由代理
    <Location /api>
        ProxyPass http://localhost:3101/api
        ProxyPassReverse http://localhost:3101/api
        
        # 設置代理頭部
        ProxySet Host $host
        ProxySet X-Real-IP $remote_addr
        ProxySet X-Forwarded-For $proxy_add_x_forwarded_for
        ProxySet X-Forwarded-Proto $scheme
        ProxySet X-Forwarded-Host $host
        
        # CORS 頭部（如果需要）
        Header always set Access-Control-Allow-Origin "*"
        Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Header always set Access-Control-Allow-Headers "Content-Type, Authorization"
    </Location>
    
    # 靜態文件代理（圖片等）
    <Location /public>
        ProxyPass http://localhost:3101/public
        ProxyPassReverse http://localhost:3101/public
    </Location>
    
    # 報告生成代理
    <Location /api/report>
        ProxyPass http://localhost:3101/api/report
        ProxyPassReverse http://localhost:3101/api/report
        
        # 增加超時時間（報告生成需要較長時間）
        ProxyTimeout 600
    </Location>
    
    # 安全頭部
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    
    # Gzip 壓縮
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
    </IfModule>
    
    # 緩存設置
    <IfModule mod_expires.c>
        ExpiresActive On
        ExpiresByType image/jpeg "access plus 1 year"
        ExpiresByType image/png "access plus 1 year"
        ExpiresByType image/gif "access plus 1 year"
        ExpiresByType application/javascript "access plus 1 month"
        ExpiresByType text/css "access plus 1 month"
    </IfModule>
</VirtualHost>

